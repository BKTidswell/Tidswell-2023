---
title: "Fish Comparisons"
output: html_notebook
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(car)
library(mgcv)
library(viridis)
```

Sets up the functions that will be used later 
```{r}
rad2deg <- function(rad) {(rad * 180) / (pi)}
deg2rad <- function(deg) {(deg * pi) / (180)}
round_any <- function(x, accuracy, f=round){f(x/ accuracy) * accuracy}
ang_mean <- function(x){rad2deg(atan(mean(sin(deg2rad(x)))/mean(cos(deg2rad(x)))))}
```

```{r}
max_x <- 2
min_x <- 2

max_y <- 2
min_y <- 0

max_d <- 2
```


#Reads in the data and alters it as needed 
```{r}
comp_data <- read.csv("Fish_Comp_Values.csv")
comp_data <- na.omit(comp_data)

comp_data <- comp_data %>% mutate(Flow = ifelse(Flow == "0", "Flow 0", "Flow 2")) %>%
                           mutate(Ablation = ifelse(Ablation == "N", "No Ablation", "Ablated")) %>%
                           mutate(Darkness = ifelse(Darkness == "N", "Light", "Dark")) %>%
                           mutate(Speed_Diff = abs(Speed_Diff)) %>%
                           mutate(Heading_Diff = abs(Heading_Diff)) %>%
                           filter(Speed_Diff <= 6) %>% 
                           mutate(quarter_heading_diff = abs(abs(Heading_Diff-90)-90)) %>%
                           mutate(Is_Aligned = ifelse(Heading_Diff < 30, 1, 0)) %>%
                           mutate(Is_Reversed = ifelse(Heading_Diff > 150, 1, 0))

sum_comp_data <- comp_data %>% mutate(X_Distance = round_any(X_Distance,0.25), 
                                      Y_Distance = round_any(abs(Y_Distance),0.25)) %>%
                               group_by(Flow,Ablation,Darkness,X_Distance,Y_Distance) %>%
                               summarise(Speed_Diff = mean(Speed_Diff),
                                         Heading_Diff = ang_mean(Heading_Diff),
                                         Sync = mean(Sync),
                                         Quarter_Heading_Diff = mean(quarter_heading_diff),
                                         Is_Aligned = mean(Is_Aligned),
                                         Is_Reversed = mean(Is_Reversed))
```

Graphs the density of the fish 
```{r}
ggplot(comp_data , aes(x = X_Distance, y = abs(Y_Distance)))+
  stat_density_2d(aes(fill = ..density..), geom = "raster", contour = FALSE) +
  scale_fill_viridis() +
  facet_wrap(~ Flow + Ablation + Darkness) +
  xlim(-3,3) + 
  ylim(0,3) +
  theme_light()
```
This creates a dataframe that is used for making model predictions and graphing them
```{r}
#Dataframe for Predictions

d <- seq(from = 0, to = 2, by = 0.1)
a <- seq(from = 0, to = 180, by = 10)

x <- seq(from = -sqrt(2), to = sqrt(2), by = 0.1)
y <- seq(from = 0, to = sqrt(2), by = 0.1)

flows <- c("Flow 0", "Flow 2")
ablation <- c("No Ablation", "Ablated")
dark <- c("Light","Dark")

#predict_df <- expand.grid(Distance = d, Angle = a, Flow = flows, Ablation = ablation, Darkness = dark)
#predict_df <- predict_df %>% mutate(X_Distance = Distance*(cos(deg2rad(Angle))), Y_Distance = Distance*(sin(deg2rad(Angle))))

predict_df <- expand.grid(X_Distance = x, Y_Distance = y, Flow = flows, Ablation = ablation, Darkness = dark)
predict_df <- predict_df %>% mutate(Distance = sqrt(X_Distance**2 + Y_Distance**2), Angle = rad2deg(atan(Y_Distance/X_Distance)))

predict_df <- predict_df %>% filter(!(Ablation == "Ablated" & Darkness == 'Dark'))
predict_df <- na.omit(predict_df)

```

## Speed Differences

First we make a GAM based on the speed data
```{r}
# speed_gam <- gam(Speed_Diff ~ s(Distance)+s(Angle)+s(Distance,Angle)+
#                               Flow+s(Distance,by=Flow)+s(Angle,by=Flow)+s(Distance,Angle,by=Flow)+
#                               Darkness+s(Distance,by=Darkness)+s(Angle,by=Darkness)+s(Distance,Angle,by=Darkness)+
#                               Ablation+s(Distance,by=Ablation)+s(Angle,by=Ablation)+s(Distance,Angle,by=Ablation),
#                               data = comp_data %>% mutate(Flow = as.factor(Flow),
#                                                           Darkness = as.factor(Darkness),
#                                                           Ablation = as.factor(Ablation)))
```

```{r}
summary(speed_gam)
speed_pred <- predict_df %>% mutate(Speed_Diff = predict.gam(speed_gam,predict_df))
```

Next we plot speed difference vs distance and angle
```{r}
ggplot(speed_pred, aes(x = Distance, y = Speed_Diff))+
  geom_smooth()+
  scale_fill_viridis() +
  facet_wrap(~ Flow + Ablation + Darkness) +
  theme_light()

ggplot(speed_pred, aes(x = Angle, y = Speed_Diff))+
  geom_smooth()+
  scale_fill_viridis() +
  facet_wrap(~ Flow + Ablation + Darkness) +
  theme_light()
```
Now we plot the modeled data as well as the actual summarized data
```{r}
ggplot(speed_pred, aes(x = X_Distance, y = Y_Distance, fill = Speed_Diff))+
  geom_tile()+
  scale_fill_viridis() +
  facet_wrap(~ Flow + Ablation + Darkness) +
  theme_light()

ggplot(sum_comp_data , aes(x = X_Distance, y = Y_Distance, fill = Speed_Diff))+
  geom_tile() +
  scale_fill_viridis() +
  facet_wrap(~ Flow + Ablation + Darkness) +
  xlim(-2,2) + 
  ylim(0,2) +
  theme_light()
```

## Heading Differences

```{r}
comp_data <- comp_data %>% mutate(quarter_heading_diff = abs(abs(Heading_Diff-90)-90)) %>%
                           mutate(Is_Aligned = ifelse(Heading_Diff < 30, 1, 0)) %>%
                           mutate(Is_Reversed = ifelse(Heading_Diff > 150, 1, 0))
```


Next we make a GAM based on the heading data
```{r}
# heading_gam <- gam(Heading_Diff ~ s(Distance)+s(Angle)+s(Distance,Angle)+
#                               Flow+s(Distance,by=Flow)+s(Angle,by=Flow)+s(Distance,Angle,by=Flow)+
#                               Darkness+s(Distance,by=Darkness)+s(Angle,by=Darkness)+s(Distance,Angle,by=Darkness)+
#                               Ablation+s(Distance,by=Ablation)+s(Angle,by=Ablation)+s(Distance,Angle,by=Ablation),
#                               data = comp_data %>% mutate(Flow = as.factor(Flow),
#                                                           Darkness = as.factor(Darkness),
#                                                           Ablation = as.factor(Ablation)))
```

```{r}
summary(heading_gam)
heading_pred <- predict_df %>% mutate(Heading_Diff = predict.gam(heading_gam,predict_df))
```

Then we plot the heading differences vs distance and angle
```{r}
ggplot(heading_pred, aes(x = Distance, y = Heading_Diff))+
  geom_smooth()+
  scale_fill_viridis() +
  facet_wrap(~ Flow + Ablation + Darkness) +
  theme_light()

ggplot(heading_pred, aes(x = Angle, y = Heading_Diff))+
  geom_smooth()+
  scale_fill_viridis() +
  facet_wrap(~ Flow + Ablation + Darkness) +
  theme_light()
```
And then we plot heading differnces on the 2D plane to compare with the actual data
```{r}
# ggplot(heading_pred, aes(x = X_Distance, y = Y_Distance, fill = Heading_Diff))+
#   geom_tile()+
#   scale_fill_viridis() +
#   facet_wrap(~ Flow + Ablation + Darkness) +
#   theme_light()

ggplot(sum_comp_data, aes(x = X_Distance, y = Y_Distance, fill = Quarter_Heading_Diff)) +
  geom_tile()+
  xlim(-2,2) +
  ylim(0,2) +
  facet_wrap(~ Flow + Ablation + Darkness) +
  scale_fill_viridis() +
  theme_light()

ggplot(sum_comp_data, aes(x = X_Distance, y = Y_Distance, fill = Is_Aligned)) +
  geom_tile()+
  xlim(-2,2) +
  ylim(0,2) +
  facet_wrap(~ Flow + Ablation + Darkness) +
  scale_fill_gradient(low = "#EEEEEE",high = "#FF0000") +
  theme_light()

ggplot(sum_comp_data, aes(x = X_Distance, y = Y_Distance, fill = Is_Reversed)) +
  geom_tile()+
  xlim(-2,2) +
  ylim(0,2) +
  facet_wrap(~ Flow + Ablation + Darkness) +
  scale_fill_gradient(low = "#EEEEEE",high = "#0000FF") +
  theme_light()

```
##Sync Differences

```{r}
# sync_gam <- gam(Sync ~ s(Distance)+s(Angle)+s(Distance,Angle)+
#                               Flow+s(Distance,by=Flow)+s(Angle,by=Flow)+s(Distance,Angle,by=Flow)+
#                               Darkness+s(Distance,by=Darkness)+s(Angle,by=Darkness)+s(Distance,Angle,by=Darkness)+
#                               Ablation+s(Distance,by=Ablation)+s(Angle,by=Ablation)+s(Distance,Angle,by=Ablation),
#                               data = comp_data %>% mutate(Flow = as.factor(Flow),
#                                                           Darkness = as.factor(Darkness),
#                                                           Ablation = as.factor(Ablation)))
```

```{r}
summary(sync_gam)
sync_pred <- predict_df %>% mutate(Sync = predict.gam(sync_gam,predict_df))
```

Trying to do different non-gam models
```{r}

#All variables
#speed_m_all = lm(crim~.,data = Boston)

#No variables
#m0 = lm(crim~1,data = Boston)

```


```{r}
ggplot(sync_pred, aes(x = Distance, y = Sync))+
  geom_smooth()+
  scale_fill_viridis() +
  facet_wrap(~ Flow + Ablation + Darkness) +
  theme_light()

ggplot(sync_pred, aes(x = Angle, y = Sync))+
  geom_smooth()+
  scale_fill_viridis() +
  facet_wrap(~ Flow + Ablation + Darkness) +
  theme_light()
```

```{r}
ggplot(sync_pred, aes(x = X_Distance, y = Y_Distance, fill = Sync))+
  geom_tile()+
  scale_fill_viridis() +
  facet_wrap(~ Flow + Ablation + Darkness) +
  theme_light()

ggplot(sum_comp_data , aes(x = X_Distance, y = Y_Distance, fill = abs(Sync)))+
  geom_tile() +
  scale_fill_viridis() +
  facet_wrap(~ Flow + Ablation + Darkness) +
  xlim(-3,3) + 
  ylim(0,3) +
  theme_light()
```

